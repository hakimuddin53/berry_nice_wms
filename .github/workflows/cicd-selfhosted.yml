name: CI/CD - Build and Deploy to Self-Hosted Windows VM

on:
  push:
    branches: [ master ]
  workflow_dispatch:

concurrency:
  group: production-deploy
  cancel-in-progress: false

env:
  NODE_VERSION: '20.x'
  API_PROJECT: 'Wms.Api/Wms.Api.csproj'
  TEST_PROJECT: 'Wms.Api.Tests/Wms.Api.Tests.csproj'
  FRONTEND_DIR: 'Frontend'
  API_PUBLISH_DIR: 'C:\inetpub\wwwroot\wms-bn-api'
  FRONTEND_PUBLISH_DIR: 'C:\inetpub\wwwroot\wms-bn-web'

jobs:
  build-and-deploy:
    name: Build and Deploy
    runs-on: [ self-hosted, Windows ]
    defaults:
      run:
        shell: powershell

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # --- FRONTEND STEPS ---
      - name: Set up Node ${{ env.NODE_VERSION }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Build Frontend
        working-directory: ${{ env.FRONTEND_DIR }}
        env:
          CI: false
        run: |
          npm install
          npm run build

      - name: Deploy Frontend
        run: |
          if (!(Test-Path $env:FRONTEND_PUBLISH_DIR)) { New-Item -ItemType Directory -Force -Path $env:FRONTEND_PUBLISH_DIR | Out-Null }
          robocopy "$env:FRONTEND_DIR\build" "$env:FRONTEND_PUBLISH_DIR" /MIR
          if ($LASTEXITCODE -lt 8) { $global:LASTEXITCODE = 0 }

      # --- BACKEND STEPS ---
      - name: Build and Test .NET API
        run: |
          dotnet restore $env:API_PROJECT
          dotnet build $env:API_PROJECT -c Release --no-restore
          dotnet build $env:TEST_PROJECT -c Release --no-restore
          dotnet test $env:TEST_PROJECT -c Release --no-build --verbosity normal

      - name: Publish .NET API to Temp
        run: |
          $publishTemp = "$env:RUNNER_TEMP\api_publish"
          dotnet publish $env:API_PROJECT -c Release -o $publishTemp
          echo "PUBLISH_TEMP=$publishTemp" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append

      - name: Deploy .NET API
        run: |
          if (!(Test-Path $env:API_PUBLISH_DIR)) { New-Item -ItemType Directory -Force -Path $env:API_PUBLISH_DIR | Out-Null }
          
          $offlineFile = Join-Path $env:API_PUBLISH_DIR "app_offline.htm"
          "Deploying..." | Out-File -FilePath $offlineFile -Encoding utf8
          Start-Sleep -Seconds 5

          try {
            robocopy "$env:PUBLISH_TEMP" "$env:API_PUBLISH_DIR" /MIR /R:2 /W:5
            if ($LASTEXITCODE -lt 8) { $global:LASTEXITCODE = 0 }
          }
          finally {
            if (Test-Path $offlineFile) { Remove-Item $offlineFile -Force -ErrorAction SilentlyContinue }
          }

      # --- CLEANUP STEP ---
      - name: Cleanup on Success
        if: success() # Only runs if all previous steps passed
        run: |
          Write-Host "Cleaning up build artifacts to save disk space..."
          
          # 1. Remove the temp folder used for file transfer
          $publishTemp = "$env:RUNNER_TEMP\api_publish"
          if (Test-Path $publishTemp) { 
            Write-Host "Removing temp publish folder: $publishTemp"
            Remove-Item $publishTemp -Recurse -Force -ErrorAction SilentlyContinue 
          }
          
          # 2. Remove frontend build output
          $frontendBuild = Join-Path $env:GITHUB_WORKSPACE "$env:FRONTEND_DIR\build"
          if (Test-Path $frontendBuild) { 
            Write-Host "Removing frontend build folder: $frontendBuild"
            Remove-Item $frontendBuild -Recurse -Force -ErrorAction SilentlyContinue 
          }
          
          # 3. Remove frontend node_modules (saves the most space)
          $nodeModules = Join-Path $env:GITHUB_WORKSPACE "$env:FRONTEND_DIR\node_modules"
          if (Test-Path $nodeModules) { 
            Write-Host "Removing node_modules folder: $nodeModules"
            Remove-Item $nodeModules -Recurse -Force -ErrorAction SilentlyContinue 
          }
          
          # 4. Remove .NET bin and obj folders
          Write-Host "Removing .NET bin and obj folders..."
          Get-ChildItem -Path $env:GITHUB_WORKSPACE -Include bin,obj -Recurse -Directory | ForEach-Object {
            Write-Host "  Removing: $($_.FullName)"
            Remove-Item $_.FullName -Recurse -Force -ErrorAction SilentlyContinue
          }
          
          Write-Host "Cleanup completed successfully!"